<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF to Image Converter | PDF转图片转换器</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Tailwind CSS 自定义配置 -->
    <script>
        window.tailwind = {
            config: {
                darkMode: ['class'],
                theme: {
                    container: {
                        center: true,
                        padding: "2rem",
                        screens: {
                            "2xl": "1400px",
                        },
                    },
                    extend: {
                        colors: {
                            border: "hsl(var(--border))",
                            input: "hsl(var(--input))",
                            ring: "hsl(var(--ring))",
                            background: "hsl(var(--background))",
                            foreground: "hsl(var(--foreground))",
                            primary: {
                                DEFAULT: "hsl(var(--primary))",
                                foreground: "hsl(var(--primary-foreground))",
                            },
                            secondary: {
                                DEFAULT: "hsl(var(--secondary))",
                                foreground: "hsl(var(--secondary-foreground))",
                            },
                            destructive: {
                                DEFAULT: "hsl(var(--destructive))",
                                foreground: "hsl(var(--destructive-foreground))",
                            },
                            muted: {
                                DEFAULT: "hsl(var(--muted))",
                                foreground: "hsl(var(--muted-foreground))",
                            },
                            accent: {
                                DEFAULT: "hsl(var(--accent))",
                                foreground: "hsl(var(--accent-foreground))",
                            },
                            popover: {
                                DEFAULT: "hsl(var(--popover))",
                                foreground: "hsl(var(--popover-foreground))",
                            },
                            card: {
                                DEFAULT: "hsl(var(--card))",
                                foreground: "hsl(var(--card-foreground))",
                            },
                        },
                        borderRadius: {
                            lg: "var(--radius)",
                            md: "calc(var(--radius) - 2px)",
                            sm: "calc(var(--radius) - 4px)",
                        },
                    }
                }
            }
        }
    </script>
    
    <style>
        :root {
  --background: 44.0000 42.8571% 93.1373%;
  --foreground: 28.5714 16.5354% 24.9020%;
  --card: 42.0000 100.0000% 98.0392%;
  --card-foreground: 28.5714 16.5354% 24.9020%;
  --popover: 42.0000 100.0000% 98.0392%;
  --popover-foreground: 28.5714 16.5354% 24.9020%;
  --primary: 30.0000 33.8710% 48.6275%;
  --primary-foreground: 0 0% 100%;
  --secondary: 40.6452 34.8315% 82.5490%;
  --secondary-foreground: 28.9655 18.7097% 30.3922%;
  --muted: 39 34.4828% 88.6275%;
  --muted-foreground: 32.3077 18.4834% 41.3725%;
  --accent: 42.8571 32.8125% 74.9020%;
  --accent-foreground: 28.5714 16.5354% 24.9020%;
  --destructive: 9.8438 54.7009% 45.8824%;
  --destructive-foreground: 0 0% 100%;
  --border: 40.0000 31.4286% 79.4118%;
  --input: 40.0000 31.4286% 79.4118%;
  --ring: 30.0000 33.8710% 48.6275%;
  --chart-1: 30.0000 33.8710% 48.6275%;
  --chart-2: 31.3846 29.9539% 42.5490%;
  --chart-3: 33.6842 32.9480% 33.9216%;
  --chart-4: 29.1176 30.9091% 56.8627%;
  --chart-5: 30 33.6842% 62.7451%;
  --sidebar: 39 34.4828% 88.6275%;
  --sidebar-foreground: 28.5714 16.5354% 24.9020%;
  --sidebar-primary: 30.0000 33.8710% 48.6275%;
  --sidebar-primary-foreground: 0 0% 100%;
  --sidebar-accent: 42.8571 32.8125% 74.9020%;
  --sidebar-accent-foreground: 28.5714 16.5354% 24.9020%;
  --sidebar-border: 40.0000 31.4286% 79.4118%;
  --sidebar-ring: 30.0000 33.8710% 48.6275%;
  --font-sans: Libre Baskerville, serif;
  --font-serif: Lora, serif;
  --font-mono: IBM Plex Mono, monospace;
  --radius: 0.25rem;
  --shadow-2xs: 2px 3px 5px 0px hsl(28 13% 20% / 0.06);
  --shadow-xs: 2px 3px 5px 0px hsl(28 13% 20% / 0.06);
  --shadow-sm: 2px 3px 5px 0px hsl(28 13% 20% / 0.12), 2px 1px 2px -1px hsl(28 13% 20% / 0.12);
  --shadow: 2px 3px 5px 0px hsl(28 13% 20% / 0.12), 2px 1px 2px -1px hsl(28 13% 20% / 0.12);
  --shadow-md: 2px 3px 5px 0px hsl(28 13% 20% / 0.12), 2px 2px 4px -1px hsl(28 13% 20% / 0.12);
  --shadow-lg: 2px 3px 5px 0px hsl(28 13% 20% / 0.12), 2px 4px 6px -1px hsl(28 13% 20% / 0.12);
  --shadow-xl: 2px 3px 5px 0px hsl(28 13% 20% / 0.12), 2px 8px 10px -1px hsl(28 13% 20% / 0.12);
  --shadow-2xl: 2px 3px 5px 0px hsl(28 13% 20% / 0.30);
}

.dark {
  --background: 25.0000 15.3846% 15.2941%;
  --foreground: 39 34.4828% 88.6275%;
  --card: 25.7143 13.7255% 20%;
  --card-foreground: 39 34.4828% 88.6275%;
  --popover: 25.7143 13.7255% 20%;
  --popover-foreground: 39 34.4828% 88.6275%;
  --primary: 30 33.6842% 62.7451%;
  --primary-foreground: 25.0000 15.3846% 15.2941%;
  --secondary: 24.7059 12.9771% 25.6863%;
  --secondary-foreground: 39 34.4828% 88.6275%;
  --muted: 25.7143 13.7255% 20%;
  --muted-foreground: 38.4000 17.7305% 72.3529%;
  --accent: 24.4444 17.8808% 29.6078%;
  --accent-foreground: 39 34.4828% 88.6275%;
  --destructive: 9.8438 54.7009% 45.8824%;
  --destructive-foreground: 0 0% 100%;
  --border: 24.7059 12.9771% 25.6863%;
  --input: 24.7059 12.9771% 25.6863%;
  --ring: 30 33.6842% 62.7451%;
  --chart-1: 30 33.6842% 62.7451%;
  --chart-2: 29.1176 30.9091% 56.8627%;
  --chart-3: 30.0000 33.8710% 48.6275%;
  --chart-4: 31.3846 29.9539% 42.5490%;
  --chart-5: 33.6842 32.9480% 33.9216%;
  --sidebar: 25.0000 15.3846% 15.2941%;
  --sidebar-foreground: 39 34.4828% 88.6275%;
  --sidebar-primary: 30 33.6842% 62.7451%;
  --sidebar-primary-foreground: 25.0000 15.3846% 15.2941%;
  --sidebar-accent: 24.4444 17.8808% 29.6078%;
  --sidebar-accent-foreground: 39 34.4828% 88.6275%;
  --sidebar-border: 24.7059 12.9771% 25.6863%;
  --sidebar-ring: 30 33.6842% 62.7451%;
  --font-sans: Libre Baskerville, serif;
  --font-serif: Lora, serif;
  --font-mono: IBM Plex Mono, monospace;
  --radius: 0.25rem;
  --shadow-2xs: 2px 3px 5px 0px hsl(28 13% 20% / 0.06);
  --shadow-xs: 2px 3px 5px 0px hsl(28 13% 20% / 0.06);
  --shadow-sm: 2px 3px 5px 0px hsl(28 13% 20% / 0.12), 2px 1px 2px -1px hsl(28 13% 20% / 0.12);
  --shadow: 2px 3px 5px 0px hsl(28 13% 20% / 0.12), 2px 1px 2px -1px hsl(28 13% 20% / 0.12);
  --shadow-md: 2px 3px 5px 0px hsl(28 13% 20% / 0.12), 2px 2px 4px -1px hsl(28 13% 20% / 0.12);
  --shadow-lg: 2px 3px 5px 0px hsl(28 13% 20% / 0.12), 2px 4px 6px -1px hsl(28 13% 20% / 0.12);
  --shadow-xl: 2px 3px 5px 0px hsl(28 13% 20% / 0.12), 2px 8px 10px -1px hsl(28 13% 20% / 0.12);
  --shadow-2xl: 2px 3px 5px 0px hsl(28 13% 20% / 0.30);
}

        /* 基础样式 */
        * {
            border-color: hsl(var(--border));
        }

        body {
            background-color: hsl(var(--background));
            color: hsl(var(--foreground));
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* Shadcn/UI 组件样式 */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            white-space: nowrap;
            border-radius: calc(var(--radius) - 2px);
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s;
            outline: none;
            border: none;
            cursor: pointer;
            padding: 0.5rem 1rem;
            min-height: 2.5rem;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background-color: hsl(var(--primary));
            color: hsl(var(--primary-foreground));
        }

        .btn-primary:hover:not(:disabled) {
            background-color: hsl(var(--primary) / 0.9);
        }

        .btn-secondary {
            background-color: hsl(var(--secondary));
            color: hsl(var(--secondary-foreground));
        }

        .btn-secondary:hover:not(:disabled) {
            background-color: hsl(var(--secondary) / 0.8);
        }

        .btn-outline {
            border: 1px solid hsl(var(--border));
            background-color: hsl(var(--background));
            color: hsl(var(--foreground));
        }

        .btn-outline:hover:not(:disabled) {
            background-color: hsl(var(--accent));
            color: hsl(var(--accent-foreground));
        }

        .btn-destructive {
            background-color: hsl(var(--destructive));
            color: hsl(var(--destructive-foreground));
        }

        .btn-destructive:hover:not(:disabled) {
            background-color: hsl(var(--destructive) / 0.9);
        }

        .btn-ghost {
            background-color: transparent;
            color: hsl(var(--foreground));
        }

        .btn-ghost:hover:not(:disabled) {
            background-color: hsl(var(--accent));
            color: hsl(var(--accent-foreground));
        }

        .card {
            border-radius: calc(var(--radius) + 2px);
            border: 1px solid hsl(var(--border));
            background-color: hsl(var(--card));
            color: hsl(var(--card-foreground));
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
        }

        .input {
            display: flex;
            height: 2.5rem;
            width: 100%;
            border-radius: calc(var(--radius) - 2px);
            border: 1px solid hsl(var(--border));
            background-color: hsl(var(--background));
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
            color: hsl(var(--foreground));
            outline: none;
            transition: border-color 0.2s;
        }

        .input:focus {
            border-color: hsl(var(--ring));
            box-shadow: 0 0 0 2px hsl(var(--ring) / 0.2);
        }

        .input::placeholder {
            color: hsl(var(--muted-foreground));
        }

        .select {
            display: flex;
            height: 2.5rem;
            width: 100%;
            border-radius: calc(var(--radius) - 2px);
            border: 1px solid hsl(var(--border));
            background-color: hsl(var(--background));
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
            color: hsl(var(--foreground));
            outline: none;
            cursor: pointer;
        }

        .select:focus {
            border-color: hsl(var(--ring));
            box-shadow: 0 0 0 2px hsl(var(--ring) / 0.2);
        }

        .label {
            font-size: 0.875rem;
            font-weight: 500;
            line-height: 1;
            color: hsl(var(--foreground));
        }

        .progress-bar {
            height: 0.5rem;
            width: 100%;
            overflow: hidden;
            border-radius: 9999px;
            background-color: hsl(var(--secondary));
        }

        .progress-fill {
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
            background-color: hsl(var(--primary));
        }

        .alert {
            position: relative;
            width: 100%;
            border-radius: calc(var(--radius));
            border: 1px solid hsl(var(--border));
            padding: 1rem;
            background-color: hsl(var(--background));
            color: hsl(var(--foreground));
        }

        .alert-destructive {
            border-color: hsl(var(--destructive) / 0.5);
            color: hsl(var(--destructive));
            background-color: hsl(var(--destructive) / 0.1);
        }

        .upload-box {
            border: 2px dashed hsl(var(--border));
            border-radius: calc(var(--radius) + 4px);
            background-color: hsl(var(--muted) / 0.3);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-box:hover {
            border-color: hsl(var(--primary));
            background-color: hsl(var(--primary) / 0.05);
        }

        .upload-box.dragover {
            border-color: hsl(var(--primary));
            background-color: hsl(var(--primary) / 0.1);
            transform: scale(1.02);
        }

        .image-preview {
            border-radius: calc(var(--radius));
            border: 1px solid hsl(var(--border));
            background-color: hsl(var(--muted) / 0.1);
        }

        /* 主题和语言切换按钮 */
        .controls {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 50;
            display: flex;
            gap: 0.5rem;
        }

        /* 响应式调整 */
        @media (max-width: 768px) {
            .controls {
                position: relative;
                top: 0;
                right: 0;
                justify-content: center;
                margin-bottom: 1rem;
            }
        }
    </style>
</head>
<body>
    <!-- 主题和语言控制 -->
    <div class="controls">
        <button class="btn btn-ghost" onclick="toggleLanguage()" title="切换语言 / Switch Language">
            <span id="language-icon">🌐</span>
        </button>
        <button class="btn btn-ghost" onclick="toggleTheme()" title="切换主题 / Toggle Theme">
            <span id="theme-icon">🌙</span>
        </button>
    </div>

    <div class="min-h-screen bg-background">
        <div class="container mx-auto px-4 py-8 max-w-4xl">
            <!-- 头部 -->
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold text-foreground mb-4" data-key="title">PDF转图片转换器</h1>
                <p class="text-lg text-muted-foreground" data-key="subtitle">简单、快速、安全的PDF转换工具</p>
            </div>

            <!-- 上传区域 -->
            <div class="card mb-6">
                <div class="p-8">
                    <div class="upload-box p-12 text-center" id="uploadBox">
                        <div class="text-6xl mb-4">📄</div>
                        <div class="text-xl font-medium text-foreground mb-2" data-key="upload-text">点击或拖拽PDF文件到这里</div>
                        <div class="text-sm text-muted-foreground mb-4" data-key="upload-hint">支持拖拽上传，文件大小限制50MB</div>
                        <div class="text-sm text-primary font-medium" id="modeHint" data-key="mode-hint">选择"长条模式"可将多页合并为一张长图并自动去除空白</div>
                        <input type="file" id="fileInput" accept=".pdf" class="hidden" />
                    </div>
                </div>
            </div>

            <!-- 设置选项 -->
            <div class="card mb-6">
                <div class="p-6">
                    <h3 class="text-lg font-semibold mb-4" data-key="settings-title">转换设置</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="space-y-2">
                            <label class="label" data-key="mode-label">转换模式</label>
                            <select id="modeSelect" class="select">
                                <option value="separate" data-key="mode-separate">分页模式 (每页单独图片)</option>
                                <option value="merge" data-key="mode-merge">长条模式 (合并为一张长图)</option>
                            </select>
                        </div>
                        <div class="space-y-2">
                            <label class="label" data-key="format-label">图片格式</label>
                            <select id="formatSelect" class="select">
                                <option value="png" data-key="format-png">PNG (高质量)</option>
                                <option value="jpeg" data-key="format-jpeg">JPEG (较小文件)</option>
                            </select>
                        </div>
                        <div class="space-y-2">
                            <label class="label" data-key="quality-label">图片质量</label>
                            <select id="qualitySelect" class="select">
                                <option value="1" data-key="quality-low">低质量 (1x)</option>
                                <option value="1.5" selected data-key="quality-standard">标准质量 (1.5x)</option>
                                <option value="2" data-key="quality-high">高质量 (2x)</option>
                                <option value="3" data-key="quality-ultra">超高质量 (3x)</option>
                            </select>
                        </div>
                        <div class="space-y-2" id="trimSetting" style="display: none;">
                            <label class="label" data-key="trim-label">去除空白</label>
                            <select id="trimSelect" class="select">
                                <option value="auto" selected data-key="trim-auto">自动检测并去除</option>
                                <option value="top" data-key="trim-top">仅去除顶部空白</option>
                                <option value="bottom" data-key="trim-bottom">仅去除底部空白</option>
                                <option value="none" data-key="trim-none">不去除空白</option>
                            </select>
                        </div>
                        <div class="space-y-2" id="spacingSetting" style="display: none;">
                            <label class="label" data-key="spacing-label">页面间距</label>
                            <select id="spacingSelect" class="select">
                                <option value="0" data-key="spacing-none">无间距</option>
                                <option value="10" selected data-key="spacing-small">小间距 (10px)</option>
                                <option value="20" data-key="spacing-medium">中间距 (20px)</option>
                                <option value="30" data-key="spacing-large">大间距 (30px)</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 文件信息 -->
            <div class="card mb-6" id="fileInfo" style="display: none;">
                <div class="p-6">
                    <h3 class="text-lg font-semibold mb-2" data-key="file-info-title">文件信息</h3>
                    <p id="fileDetails" class="text-muted-foreground"></p>
                </div>
            </div>

            <!-- 进度条 -->
            <div class="card mb-6" id="progressContainer" style="display: none;">
                <div class="p-6">
                    <div class="progress-bar mb-2">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div class="text-center text-sm text-muted-foreground" id="progressText">准备转换...</div>
                </div>
            </div>

            <!-- 错误信息 -->
            <div class="alert alert-destructive mb-6" id="errorMessage" style="display: none;"></div>

            <!-- 转换结果 -->
            <div class="card" id="results" style="display: none;">
                <div class="p-6">
                    <h2 class="text-2xl font-semibold text-center mb-6" data-key="results-title">转换完成</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6" id="imageGrid"></div>
                    <div class="flex justify-center gap-4">
                        <button class="btn btn-primary" id="downloadAllBtn" onclick="downloadAllImages()">
                            <span data-key="download-all">下载所有图片</span>
                        </button>
                        <button class="btn btn-outline" id="resetBtn" onclick="resetApp()">
                            <span data-key="reset">转换新文件</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script>
        // 多语言配置
        const translations = {
            zh: {
                'title': 'PDF转图片转换器',
                'subtitle': '简单、快速、安全的PDF转换工具',
                'upload-text': '点击或拖拽PDF文件到这里',
                'upload-hint': '支持拖拽上传，文件大小限制50MB',
                'mode-hint': '选择"长条模式"可将多页合并为一张长图并自动去除空白',
                'settings-title': '转换设置',
                'mode-label': '转换模式',
                'mode-separate': '分页模式 (每页单独图片)',
                'mode-merge': '长条模式 (合并为一张长图)',
                'format-label': '图片格式',
                'format-png': 'PNG (高质量)',
                'format-jpeg': 'JPEG (较小文件)',
                'quality-label': '图片质量',
                'quality-low': '低质量 (1x)',
                'quality-standard': '标准质量 (1.5x)',
                'quality-high': '高质量 (2x)',
                'quality-ultra': '超高质量 (3x)',
                'trim-label': '去除空白',
                'trim-auto': '自动检测并去除',
                'trim-top': '仅去除顶部空白',
                'trim-bottom': '仅去除底部空白',
                'trim-none': '不去除空白',
                'spacing-label': '页面间距',
                'spacing-none': '无间距',
                'spacing-small': '小间距 (10px)',
                'spacing-medium': '中间距 (20px)',
                'spacing-large': '大间距 (30px)',
                'file-info-title': '文件信息',
                'results-title': '转换完成',
                'download-all': '下载所有图片',
                'download-long': '下载长图',
                'reset': '转换新文件',
                'page': '第 {0} 页',
                'download': '下载',
                'long-image': '长图模式 ({0} 页合并)',
                'download-long-image': '下载长图',
                'error-file-type': '请选择PDF文件！',
                'error-file-size': '文件大小不能超过50MB！',
                'error-conversion': 'PDF转换失败: {0}',
                'status-reading': '正在读取PDF文件...',
                'status-found-pages': '发现 {0} 页，开始转换...',
                'status-converting': '正在转换第 {0}/{1} 页...',
                'status-rendering': '正在渲染第 {0}/{1} 页...',
                'status-processing': '正在处理空白区域...',
                'status-trimming': '正在处理第 {0} 页空白...',
                'status-merging': '正在合并为长图...',
                'status-complete': '转换完成！',
                'status-packing': '正在打包...',
                'error-packing': '打包下载失败: {0}',
                'file-info': '文件名: {0} | 大小: {1}MB'
            },
            en: {
                'title': 'PDF to Image Converter',
                'subtitle': 'Simple, fast, and secure PDF conversion tool',
                'upload-text': 'Click or drag PDF files here',
                'upload-hint': 'Supports drag and drop, file size limit 50MB',
                'mode-hint': 'Select "Long Mode" to merge pages into one long image with automatic whitespace removal',
                'settings-title': 'Conversion Settings',
                'mode-label': 'Conversion Mode',
                'mode-separate': 'Separate Mode (Individual images per page)',
                'mode-merge': 'Long Mode (Merge into one long image)',
                'format-label': 'Image Format',
                'format-png': 'PNG (High Quality)',
                'format-jpeg': 'JPEG (Smaller File)',
                'quality-label': 'Image Quality',
                'quality-low': 'Low Quality (1x)',
                'quality-standard': 'Standard Quality (1.5x)',
                'quality-high': 'High Quality (2x)',
                'quality-ultra': 'Ultra Quality (3x)',
                'trim-label': 'Whitespace Removal',
                'trim-auto': 'Auto detect and remove',
                'trim-top': 'Remove top whitespace only',
                'trim-bottom': 'Remove bottom whitespace only',
                'trim-none': 'No whitespace removal',
                'spacing-label': 'Page Spacing',
                'spacing-none': 'No spacing',
                'spacing-small': 'Small spacing (10px)',
                'spacing-medium': 'Medium spacing (20px)',
                'spacing-large': 'Large spacing (30px)',
                'file-info-title': 'File Information',
                'results-title': 'Conversion Complete',
                'download-all': 'Download All Images',
                'download-long': 'Download Long Image',
                'reset': 'Convert New File',
                'page': 'Page {0}',
                'download': 'Download',
                'long-image': 'Long Image Mode ({0} pages merged)',
                'download-long-image': 'Download Long Image',
                'error-file-type': 'Please select a PDF file!',
                'error-file-size': 'File size cannot exceed 50MB!',
                'error-conversion': 'PDF conversion failed: {0}',
                'status-reading': 'Reading PDF file...',
                'status-found-pages': 'Found {0} pages, starting conversion...',
                'status-converting': 'Converting page {0}/{1}...',
                'status-rendering': 'Rendering page {0}/{1}...',
                'status-processing': 'Processing whitespace areas...',
                'status-trimming': 'Processing page {0} whitespace...',
                'status-merging': 'Merging into long image...',
                'status-complete': 'Conversion complete!',
                'status-packing': 'Packing...',
                'error-packing': 'Packing download failed: {0}',
                'file-info': 'Filename: {0} | Size: {1}MB'
            }
        };

        // 设置 PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // 全局变量
        let currentLanguage = localStorage.getItem('language') || 'zh';
        let convertedImages = [];
        let mergedImage = null;

        // DOM 元素
        const uploadBox = document.getElementById('uploadBox');
        const fileInput = document.getElementById('fileInput');
        const fileInfo = document.getElementById('fileInfo');
        const fileDetails = document.getElementById('fileDetails');
        const progressContainer = document.getElementById('progressContainer');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        const errorMessage = document.getElementById('errorMessage');
        const results = document.getElementById('results');
        const imageGrid = document.getElementById('imageGrid');
        const modeSelect = document.getElementById('modeSelect');
        const formatSelect = document.getElementById('formatSelect');
        const qualitySelect = document.getElementById('qualitySelect');
        const trimSelect = document.getElementById('trimSelect');
        const spacingSelect = document.getElementById('spacingSelect');
        const trimSetting = document.getElementById('trimSetting');
        const spacingSetting = document.getElementById('spacingSetting');
        const downloadAllBtn = document.getElementById('downloadAllBtn');
        const resetBtn = document.getElementById('resetBtn');

        // 多语言函数
        function t(key, ...args) {
            let text = translations[currentLanguage][key] || key;
            args.forEach((arg, index) => {
                text = text.replace(`{${index}}`, arg);
            });
            return text;
        }

        function updateLanguage() {
            document.querySelectorAll('[data-key]').forEach(element => {
                const key = element.getAttribute('data-key');
                if (element.tagName === 'OPTION') {
                    element.textContent = t(key);
                } else {
                    element.textContent = t(key);
                }
            });
            
            // 更新文档语言属性
            document.documentElement.lang = currentLanguage === 'zh' ? 'zh-CN' : 'en';
            
            // 更新页面标题
            document.title = currentLanguage === 'zh' ? 'PDF转图片转换器' : 'PDF to Image Converter';
            
            // 更新模式提示
            updateModeHint();
            
            // 更新下载按钮文本
            updateDownloadButtonText();
        }

        function toggleLanguage() {
            currentLanguage = currentLanguage === 'zh' ? 'en' : 'zh';
            localStorage.setItem('language', currentLanguage);
            updateLanguage();
        }

        // 主题切换
        function toggleTheme() {
            const html = document.documentElement;
            const themeIcon = document.getElementById('theme-icon');
            
            if (html.classList.contains('dark')) {
                html.classList.remove('dark');
                themeIcon.textContent = '🌙';
                localStorage.setItem('theme', 'light');
            } else {
                html.classList.add('dark');
                themeIcon.textContent = '☀️';
                localStorage.setItem('theme', 'dark');
            }
        }

        // 初始化主题
        function initTheme() {
            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            
            if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
                document.documentElement.classList.add('dark');
                document.getElementById('theme-icon').textContent = '☀️';
            }
        }

        // 事件监听
        uploadBox.addEventListener('click', () => fileInput.click());
        uploadBox.addEventListener('dragover', handleDragOver);
        uploadBox.addEventListener('dragleave', handleDragLeave);
        uploadBox.addEventListener('drop', handleDrop);
        fileInput.addEventListener('change', handleFileSelect);
        modeSelect.addEventListener('change', handleModeChange);

        // 拖拽事件处理
        function handleDragOver(e) {
            e.preventDefault();
            uploadBox.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            uploadBox.classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            uploadBox.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        }

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                handleFile(file);
            }
        }

        // 模式切换处理
        function handleModeChange() {
            const isLongMode = modeSelect.value === 'merge';
            trimSetting.style.display = isLongMode ? 'block' : 'none';
            spacingSetting.style.display = isLongMode ? 'block' : 'none';
            updateModeHint();
            updateDownloadButtonText();
        }

        // 更新模式提示
        function updateModeHint() {
            const modeHint = document.getElementById('modeHint');
            const mode = modeSelect.value;
            
            if (mode === 'merge') {
                modeHint.textContent = t('mode-hint');
                modeHint.className = 'text-sm text-primary font-medium';
            } else {
                modeHint.textContent = currentLanguage === 'zh' ? 
                    '分页模式：每个PDF页面转换为单独的图片文件' : 
                    'Separate mode: Convert each PDF page to individual image files';
                modeHint.className = 'text-sm text-muted-foreground font-medium';
            }
        }

        // 更新下载按钮文本
        function updateDownloadButtonText() {
            const mode = modeSelect.value;
            const downloadText = mode === 'merge' ? t('download-long') : t('download-all');
            downloadAllBtn.querySelector('span').textContent = downloadText;
        }

        // 文件处理
        function handleFile(file) {
            // 验证文件类型
            if (file.type !== 'application/pdf') {
                showError(t('error-file-type'));
                return;
            }

            // 验证文件大小 (50MB)
            if (file.size > 50 * 1024 * 1024) {
                showError(t('error-file-size'));
                return;
            }

            // 显示文件信息
            showFileInfo(file);

            // 开始转换
            convertPDFToImages(file);
        }

        // 显示文件信息
        function showFileInfo(file) {
            const sizeInMB = (file.size / (1024 * 1024)).toFixed(2);
            fileDetails.textContent = t('file-info', file.name, sizeInMB);
            fileInfo.style.display = 'block';
        }

        // PDF转图片核心功能
        async function convertPDFToImages(file) {
            try {
                hideError();
                showProgress(0, t('status-reading'));

                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                
                showProgress(10, t('status-found-pages', pdf.numPages));

                const mode = modeSelect.value;
                const format = formatSelect.value;
                const scale = parseFloat(qualitySelect.value);

                if (mode === 'separate') {
                    await convertToSeparateImages(pdf, format, scale);
                } else {
                    await convertToLongImage(pdf, format, scale);
                }

                showProgress(100, t('status-complete'));
                setTimeout(() => {
                    hideProgress();
                    showResults();
                }, 500);

            } catch (error) {
                console.error('转换失败:', error);
                showError(t('error-conversion', error.message));
                hideProgress();
            }
        }

        // 分页模式转换
        async function convertToSeparateImages(pdf, format, scale) {
            convertedImages = [];
            imageGrid.innerHTML = '';

            for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                const progress = 10 + (pageNum / pdf.numPages) * 80;
                showProgress(progress, t('status-converting', pageNum, pdf.numPages));

                const page = await pdf.getPage(pageNum);
                const viewport = page.getViewport({ scale });

                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                canvas.height = viewport.height;
                canvas.width = viewport.width;

                await page.render({
                    canvasContext: context,
                    viewport: viewport
                }).promise;

                const mimeType = format === 'png' ? 'image/png' : 'image/jpeg';
                const quality = format === 'jpeg' ? 0.9 : undefined;
                const dataUrl = canvas.toDataURL(mimeType, quality);

                convertedImages.push({
                    dataUrl,
                    pageNumber: pageNum,
                    filename: `page_${pageNum.toString().padStart(3, '0')}.${format}`
                });

                addImageToGrid(dataUrl, pageNum, format, true);
            }
        }

        // 长条模式转换
        async function convertToLongImage(pdf, format, scale) {
            const trimMode = trimSelect.value;
            const spacing = parseInt(spacingSelect.value);
            const pageCanvases = [];

            // 第一步：渲染所有页面
            for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                const progress = 10 + (pageNum / pdf.numPages) * 40;
                showProgress(progress, t('status-rendering', pageNum, pdf.numPages));

                const page = await pdf.getPage(pageNum);
                const viewport = page.getViewport({ scale });

                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                canvas.height = viewport.height;
                canvas.width = viewport.width;

                await page.render({
                    canvasContext: context,
                    viewport: viewport
                }).promise;

                pageCanvases.push(canvas);
            }

            // 第二步：处理空白和合并
            showProgress(60, t('status-processing'));
            
            const trimmedCanvases = pageCanvases.map((canvas, index) => {
                showProgress(60 + (index / pageCanvases.length) * 20, t('status-trimming', index + 1));
                return trimWhitespace(canvas, trimMode);
            });

            // 第三步：合并为长图
            showProgress(80, t('status-merging'));
            const mergedCanvas = await mergeCanvases(trimmedCanvases, spacing);

            const mimeType = format === 'png' ? 'image/png' : 'image/jpeg';
            const quality = format === 'jpeg' ? 0.9 : undefined;
            const dataUrl = mergedCanvas.toDataURL(mimeType, quality);

            mergedImage = {
                dataUrl,
                filename: `merged_long_image.${format}`,
                width: mergedCanvas.width,
                height: mergedCanvas.height
            };

            // 清空网格并添加长图预览
            imageGrid.innerHTML = '';
            addLongImageToGrid(dataUrl, pdf.numPages, format);
        }

        // 去除空白的函数
        function trimWhitespace(canvas, trimMode) {
            const ctx = canvas.getContext('2d');
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;

            let top = 0, bottom = canvas.height, left = 0, right = canvas.width;

            // 检测空白区域 (白色或接近白色的像素)
            function isWhitePixel(r, g, b, a) {
                if (a < 10) return true; // 透明像素
                return r > 250 && g > 250 && b > 250; // 接近白色
            }

            if (trimMode === 'auto' || trimMode === 'top') {
                // 检测顶部空白
                topLoop: for (let y = 0; y < canvas.height; y++) {
                    for (let x = 0; x < canvas.width; x++) {
                        const idx = (y * canvas.width + x) * 4;
                        const r = data[idx];
                        const g = data[idx + 1];
                        const b = data[idx + 2];
                        const a = data[idx + 3];
                        if (!isWhitePixel(r, g, b, a)) {
                            top = Math.max(0, y - 10);
                            break topLoop;
                        }
                    }
                }
            }

            if (trimMode === 'auto' || trimMode === 'bottom') {
                // 检测底部空白
                bottomLoop: for (let y = canvas.height - 1; y >= 0; y--) {
                    for (let x = 0; x < canvas.width; x++) {
                        const idx = (y * canvas.width + x) * 4;
                        const r = data[idx];
                        const g = data[idx + 1];
                        const b = data[idx + 2];
                        const a = data[idx + 3];
                        if (!isWhitePixel(r, g, b, a)) {
                            bottom = Math.min(canvas.height, y + 10);
                            break bottomLoop;
                        }
                    }
                }
            }

            if (trimMode === 'auto') {
                // 检测左侧空白
                leftLoop: for (let x = 0; x < canvas.width; x++) {
                    for (let y = top; y < bottom; y++) {
                        const idx = (y * canvas.width + x) * 4;
                        const r = data[idx];
                        const g = data[idx + 1];
                        const b = data[idx + 2];
                        const a = data[idx + 3];
                        if (!isWhitePixel(r, g, b, a)) {
                            left = Math.max(0, x - 5);
                            break leftLoop;
                        }
                    }
                }

                // 检测右侧空白
                rightLoop: for (let x = canvas.width - 1; x >= 0; x--) {
                    for (let y = top; y < bottom; y++) {
                        const idx = (y * canvas.width + x) * 4;
                        const r = data[idx];
                        const g = data[idx + 1];
                        const b = data[idx + 2];
                        const a = data[idx + 3];
                        if (!isWhitePixel(r, g, b, a)) {
                            right = Math.min(canvas.width, x + 5);
                            break rightLoop;
                        }
                    }
                }
            }

            // 创建裁剪后的canvas
            const trimmedCanvas = document.createElement('canvas');
            const trimmedCtx = trimmedCanvas.getContext('2d');
            
            const newWidth = right - left;
            const newHeight = bottom - top;
            
            trimmedCanvas.width = newWidth;
            trimmedCanvas.height = newHeight;

            trimmedCtx.drawImage(
                canvas,
                left, top, newWidth, newHeight,
                0, 0, newWidth, newHeight
            );

            return trimmedCanvas;
        }

        // 合并多个canvas为长图
        async function mergeCanvases(canvases, spacing) {
            if (canvases.length === 0) return null;

            const maxWidth = Math.max(...canvases.map(c => c.width));
            const totalHeight = canvases.reduce((sum, c) => sum + c.height, 0) + spacing * (canvases.length - 1);

            const mergedCanvas = document.createElement('canvas');
            const ctx = mergedCanvas.getContext('2d');
            
            mergedCanvas.width = maxWidth;
            mergedCanvas.height = totalHeight;

            // 填充白色背景
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, maxWidth, totalHeight);

            // 逐个绘制页面
            let currentY = 0;
            for (let i = 0; i < canvases.length; i++) {
                const canvas = canvases[i];
                const x = Math.floor((maxWidth - canvas.width) / 2);
                
                ctx.drawImage(canvas, x, currentY);
                currentY += canvas.height + spacing;
            }

            return mergedCanvas;
        }

        // 添加图片到网格
        function addImageToGrid(dataUrl, pageNumber, format, showDownload = true) {
            const imageItem = document.createElement('div');
            imageItem.className = 'card overflow-hidden';
            
            const downloadBtn = showDownload ? 
                `<button class="btn btn-primary btn-sm mt-2" onclick="downloadImage(${pageNumber - 1})">${t('download')}</button>` : '';
            
            imageItem.innerHTML = `
                <img src="${dataUrl}" alt="Page ${pageNumber}" class="image-preview w-full h-48 object-contain">
                <div class="p-4 text-center">
                    <div class="font-medium text-foreground mb-2">${t('page', pageNumber)}</div>
                    ${downloadBtn}
                </div>
            `;
            
            imageGrid.appendChild(imageItem);
        }

        // 添加长图到网格
        function addLongImageToGrid(dataUrl, totalPages, format) {
            const imageItem = document.createElement('div');
            imageItem.className = 'card overflow-hidden col-span-full';
            
            const sizeInfo = mergedImage ? `${mergedImage.width} × ${mergedImage.height}px` : '';
            
            imageItem.innerHTML = `
                <img src="${dataUrl}" alt="Merged Long Image" class="image-preview w-full h-auto max-h-96 object-contain">
                <div class="p-4 text-center">
                    <div class="font-medium text-foreground mb-1">${t('long-image', totalPages)}</div>
                    <div class="text-sm text-muted-foreground mb-3">${sizeInfo}</div>
                    <button class="btn btn-primary" onclick="downloadLongImage()">${t('download-long-image')}</button>
                </div>
            `;
            
            imageGrid.appendChild(imageItem);
        }

        // 下载单个图片
        function downloadImage(index) {
            if (convertedImages[index]) {
                const image = convertedImages[index];
                const link = document.createElement('a');
                link.download = image.filename;
                link.href = image.dataUrl;
                link.click();
            }
        }

        // 下载长图
        function downloadLongImage() {
            if (mergedImage) {
                const link = document.createElement('a');
                link.download = mergedImage.filename;
                link.href = mergedImage.dataUrl;
                link.click();
            }
        }

        // 下载所有图片
        async function downloadAllImages() {
            const mode = modeSelect.value;
            
            if (mode === 'merge') {
                downloadLongImage();
                return;
            }

            if (convertedImages.length === 0) return;

            try {
                downloadAllBtn.querySelector('span').textContent = t('status-packing');
                downloadAllBtn.disabled = true;

                const zip = new JSZip();
                
                for (const image of convertedImages) {
                    const response = await fetch(image.dataUrl);
                    const blob = await response.blob();
                    zip.file(image.filename, blob);
                }

                const zipBlob = await zip.generateAsync({ type: 'blob' });
                const link = document.createElement('a');
                link.download = 'pdf_images.zip';
                link.href = URL.createObjectURL(zipBlob);
                link.click();

                downloadAllBtn.querySelector('span').textContent = t('download-all');
                downloadAllBtn.disabled = false;

            } catch (error) {
                showError(t('error-packing', error.message));
                downloadAllBtn.querySelector('span').textContent = t('download-all');
                downloadAllBtn.disabled = false;
            }
        }

        // 显示/隐藏进度
        function showProgress(percent, text) {
            progressContainer.style.display = 'block';
            progressFill.style.width = percent + '%';
            progressText.textContent = text;
        }

        function hideProgress() {
            progressContainer.style.display = 'none';
        }

        // 显示/隐藏错误
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
        }

        function hideError() {
            errorMessage.style.display = 'none';
        }

        // 显示结果
        function showResults() {
            results.style.display = 'block';
        }

        // 重置应用
        function resetApp() {
            fileInput.value = '';
            fileInfo.style.display = 'none';
            results.style.display = 'none';
            imageGrid.innerHTML = '';
            convertedImages = [];
            mergedImage = null;
            hideError();
            hideProgress();
            updateDownloadButtonText();
        }

        // 初始化
        function init() {
            initTheme();
            updateLanguage();
            handleModeChange();
            
            // 监听系统主题变化
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
                if (!localStorage.getItem('theme')) {
                    if (e.matches) {
                        document.documentElement.classList.add('dark');
                        document.getElementById('theme-icon').textContent = '☀️';
                    } else {
                        document.documentElement.classList.remove('dark');
                        document.getElementById('theme-icon').textContent = '🌙';
                    }
                }
            });
        }

        // 防止页面拖拽打开文件
        document.addEventListener('dragover', e => e.preventDefault());
        document.addEventListener('drop', e => e.preventDefault());

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>