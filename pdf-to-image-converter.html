<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDFè½¬å›¾ç‰‡è½¬æ¢å™¨</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #ff6b6b, #feca57);
            color: white;
            padding: 40px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .upload-area {
            padding: 40px;
            text-align: center;
        }

        .upload-box {
            border: 3px dashed #ddd;
            border-radius: 15px;
            padding: 60px 40px;
            background: #fafafa;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }

        .upload-box:hover {
            border-color: #667eea;
            background: #f0f4ff;
            transform: translateY(-2px);
        }

        .upload-box.dragover {
            border-color: #ff6b6b;
            background: #fff5f5;
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 4em;
            color: #ddd;
            margin-bottom: 20px;
            transition: color 0.3s ease;
        }

        .upload-box:hover .upload-icon {
            color: #667eea;
        }

        .upload-text {
            font-size: 1.2em;
            color: #666;
            margin-bottom: 15px;
        }

        .upload-hint {
            color: #999;
            font-size: 0.9em;
        }

        #fileInput {
            display: none;
        }

        .btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .progress-container {
            padding: 0 40px 20px;
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #f0f0f0;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff6b6b, #feca57);
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            text-align: center;
            margin-top: 10px;
            color: #666;
        }

        .results {
            padding: 40px;
            display: none;
        }

        .results h2 {
            color: #333;
            margin-bottom: 20px;
            text-align: center;
        }

        .image-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .image-item {
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .image-item:hover {
            transform: translateY(-5px);
        }

        .image-preview {
            width: 100%;
            height: 200px;
            object-fit: contain;
            border-radius: 8px;
            background: #f9f9f9;
            border: 1px solid #eee;
        }

        .image-info {
            margin-top: 10px;
            text-align: center;
        }

        .page-number {
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .download-btn {
            background: linear-gradient(135deg, #ff6b6b, #feca57);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 15px;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .download-btn:hover {
            transform: scale(1.05);
        }

        .download-all {
            text-align: center;
            margin-top: 20px;
        }

        .error-message {
            background: #ffe6e6;
            color: #d63031;
            padding: 15px;
            border-radius: 8px;
            margin: 20px;
            border-left: 4px solid #d63031;
            display: none;
        }

        .file-info {
            background: #f8f9fa;
            padding: 20px;
            margin: 20px 40px;
            border-radius: 10px;
            display: none;
        }

        .file-info h3 {
            color: #333;
            margin-bottom: 10px;
        }

        .settings {
            padding: 20px 40px;
            border-top: 1px solid #eee;
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .setting-item label {
            color: #666;
            font-weight: 500;
        }

        .setting-item select,
        .setting-item input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: white;
        }

        .long-image {
            grid-column: 1 / -1;
            max-width: 100%;
        }

        .long-image .image-preview {
            width: 100%;
            height: auto;
            max-height: 500px;
            object-fit: contain;
        }

        .trim-info {
            background: #e3f2fd;
            color: #1565c0;
            padding: 10px;
            border-radius: 6px;
            font-size: 0.9em;
            margin-top: 10px;
            border-left: 3px solid #2196f3;
        }

        .mode-hint {
            background: #f3e5f5;
            color: #7b1fa2;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.85em;
            margin-top: 5px;
            text-align: center;
        }
            .container {
                margin: 10px;
                border-radius: 15px;
            }
            
            .header {
                padding: 30px 20px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .upload-area {
                padding: 20px;
            }
            
            .upload-box {
                padding: 40px 20px;
            }
            
            .image-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
                gap: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å¤´éƒ¨ -->
        <div class="header">
            <h1>ğŸ“„â¡ï¸ğŸ–¼ï¸ PDFè½¬å›¾ç‰‡</h1>
            <p>ç®€å•ã€å¿«é€Ÿã€å®‰å…¨çš„PDFè½¬æ¢å·¥å…·</p>
        </div>

        <!-- ä¸Šä¼ åŒºåŸŸ -->
        <div class="upload-area">
            <div class="upload-box" id="uploadBox">
                <div class="upload-icon">ğŸ“</div>
                <div class="upload-text">ç‚¹å‡»æˆ–æ‹–æ‹½PDFæ–‡ä»¶åˆ°è¿™é‡Œ</div>
                <div class="upload-hint">æ”¯æŒæ‹–æ‹½ä¸Šä¼ ï¼Œæ–‡ä»¶å¤§å°é™åˆ¶50MB</div>
                <input type="file" id="fileInput" accept=".pdf" />
            </div>
        </div>

        <!-- è®¾ç½®é€‰é¡¹ -->
        <div class="settings">
            <div class="setting-item">
                <label>è½¬æ¢æ¨¡å¼:</label>
                <select id="modeSelect">
                    <option value="separate">åˆ†é¡µæ¨¡å¼ (æ¯é¡µå•ç‹¬å›¾ç‰‡)</option>
                    <option value="merge">é•¿æ¡æ¨¡å¼ (åˆå¹¶ä¸ºä¸€å¼ é•¿å›¾)</option>
                </select>
            </div>
            <div class="setting-item">
                <label>å›¾ç‰‡æ ¼å¼:</label>
                <select id="formatSelect">
                    <option value="png">PNG (é«˜è´¨é‡)</option>
                    <option value="jpeg">JPEG (è¾ƒå°æ–‡ä»¶)</option>
                </select>
            </div>
            <div class="setting-item">
                <label>å›¾ç‰‡è´¨é‡:</label>
                <select id="qualitySelect">
                    <option value="1">ä½è´¨é‡ (1x)</option>
                    <option value="1.5" selected>æ ‡å‡†è´¨é‡ (1.5x)</option>
                    <option value="2">é«˜è´¨é‡ (2x)</option>
                    <option value="3">è¶…é«˜è´¨é‡ (3x)</option>
                </select>
            </div>
            <div class="setting-item" id="trimSetting">
                <label>å»é™¤ç©ºç™½:</label>
                <select id="trimSelect">
                    <option value="auto" selected>è‡ªåŠ¨æ£€æµ‹å¹¶å»é™¤</option>
                    <option value="top">ä»…å»é™¤é¡¶éƒ¨ç©ºç™½</option>
                    <option value="bottom">ä»…å»é™¤åº•éƒ¨ç©ºç™½</option>
                    <option value="none">ä¸å»é™¤ç©ºç™½</option>
                </select>
            </div>
            <div class="setting-item" id="spacingSetting">
                <label>é¡µé¢é—´è·:</label>
                <select id="spacingSelect">
                    <option value="0">æ— é—´è·</option>
                    <option value="10" selected>å°é—´è· (10px)</option>
                    <option value="20">ä¸­é—´è· (20px)</option>
                    <option value="30">å¤§é—´è· (30px)</option>
                </select>
            </div>
        </div>

        <!-- æ–‡ä»¶ä¿¡æ¯ -->
        <div class="file-info" id="fileInfo">
            <h3>ğŸ“‹ æ–‡ä»¶ä¿¡æ¯</h3>
            <p id="fileDetails"></p>
        </div>

        <!-- è¿›åº¦æ¡ -->
        <div class="progress-container" id="progressContainer">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text" id="progressText">å‡†å¤‡è½¬æ¢...</div>
        </div>

        <!-- é”™è¯¯ä¿¡æ¯ -->
        <div class="error-message" id="errorMessage"></div>

        <!-- è½¬æ¢ç»“æœ -->
        <div class="results" id="results">
            <h2>ğŸ‰ è½¬æ¢å®Œæˆ</h2>
            <div class="image-grid" id="imageGrid"></div>
            <div class="download-all">
                <button class="btn" id="downloadAllBtn">ğŸ“¦ ä¸‹è½½æ‰€æœ‰å›¾ç‰‡ (ZIP)</button>
                <button class="btn" id="resetBtn">ğŸ”„ è½¬æ¢æ–°æ–‡ä»¶</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script>
        // è®¾ç½® PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // DOM å…ƒç´ 
        const uploadBox = document.getElementById('uploadBox');
        const fileInput = document.getElementById('fileInput');
        const fileInfo = document.getElementById('fileInfo');
        const fileDetails = document.getElementById('fileDetails');
        const progressContainer = document.getElementById('progressContainer');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        const errorMessage = document.getElementById('errorMessage');
        const results = document.getElementById('results');
        const imageGrid = document.getElementById('imageGrid');
        const formatSelect = document.getElementById('formatSelect');
        const qualitySelect = document.getElementById('qualitySelect');
        const modeSelect = document.getElementById('modeSelect');
        const trimSelect = document.getElementById('trimSelect');
        const spacingSelect = document.getElementById('spacingSelect');
        const trimSetting = document.getElementById('trimSetting');
        const spacingSetting = document.getElementById('spacingSetting');

        let convertedImages = [];
        let mergedImage = null;

        // æ¨¡å¼åˆ‡æ¢äº‹ä»¶
        modeSelect.addEventListener('change', handleModeChange);

        function handleModeChange() {
            const isLongMode = modeSelect.value === 'merge';
            trimSetting.style.display = isLongMode ? 'flex' : 'none';
            spacingSetting.style.display = isLongMode ? 'flex' : 'none';
        }

        // åˆå§‹åŒ–æ˜¾ç¤ºçŠ¶æ€
        handleModeChange();

        // ä¸Šä¼ åŒºåŸŸäº‹ä»¶
        uploadBox.addEventListener('click', () => fileInput.click());
        uploadBox.addEventListener('dragover', handleDragOver);
        uploadBox.addEventListener('dragleave', handleDragLeave);
        uploadBox.addEventListener('drop', handleDrop);
        fileInput.addEventListener('change', handleFileSelect);
        downloadAllBtn.addEventListener('click', downloadAllImages);
        resetBtn.addEventListener('click', resetApp);

        // æ‹–æ‹½äº‹ä»¶å¤„ç†
        function handleDragOver(e) {
            e.preventDefault();
            uploadBox.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            uploadBox.classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            uploadBox.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        }

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                handleFile(file);
            }
        }

        // æ–‡ä»¶å¤„ç†
        function handleFile(file) {
            // éªŒè¯æ–‡ä»¶ç±»å‹
            if (file.type !== 'application/pdf') {
                showError('è¯·é€‰æ‹©PDFæ–‡ä»¶ï¼');
                return;
            }

            // éªŒè¯æ–‡ä»¶å¤§å° (50MB)
            if (file.size > 50 * 1024 * 1024) {
                showError('æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡50MBï¼');
                return;
            }

            // æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
            showFileInfo(file);

            // å¼€å§‹è½¬æ¢
            convertPDFToImages(file);
        }

        // æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
        function showFileInfo(file) {
            const sizeInMB = (file.size / (1024 * 1024)).toFixed(2);
            fileDetails.textContent = `æ–‡ä»¶å: ${file.name} | å¤§å°: ${sizeInMB}MB`;
            fileInfo.style.display = 'block';
        }

        // PDFè½¬å›¾ç‰‡æ ¸å¿ƒåŠŸèƒ½
        async function convertPDFToImages(file) {
            try {
                hideError();
                showProgress(0, 'æ­£åœ¨è¯»å–PDFæ–‡ä»¶...');

                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                
                showProgress(10, `å‘ç° ${pdf.numPages} é¡µï¼Œå¼€å§‹è½¬æ¢...`);

                const mode = modeSelect.value;
                const format = formatSelect.value;
                const scale = parseFloat(qualitySelect.value);

                if (mode === 'separate') {
                    // åˆ†é¡µæ¨¡å¼
                    await convertToSeparateImages(pdf, format, scale);
                } else {
                    // é•¿æ¡æ¨¡å¼
                    await convertToLongImage(pdf, format, scale);
                }

                showProgress(100, 'è½¬æ¢å®Œæˆï¼');
                setTimeout(() => {
                    hideProgress();
                    showResults();
                }, 500);

            } catch (error) {
                console.error('è½¬æ¢å¤±è´¥:', error);
                showError('PDFè½¬æ¢å¤±è´¥: ' + error.message);
                hideProgress();
            }
        }

        // åˆ†é¡µæ¨¡å¼è½¬æ¢
        async function convertToSeparateImages(pdf, format, scale) {
            convertedImages = [];
            imageGrid.innerHTML = '';

            for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                const progress = 10 + (pageNum / pdf.numPages) * 80;
                showProgress(progress, `æ­£åœ¨è½¬æ¢ç¬¬ ${pageNum}/${pdf.numPages} é¡µ...`);

                const page = await pdf.getPage(pageNum);
                const viewport = page.getViewport({ scale });

                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                canvas.height = viewport.height;
                canvas.width = viewport.width;

                await page.render({
                    canvasContext: context,
                    viewport: viewport
                }).promise;

                const mimeType = format === 'png' ? 'image/png' : 'image/jpeg';
                const quality = format === 'jpeg' ? 0.9 : undefined;
                const dataUrl = canvas.toDataURL(mimeType, quality);

                convertedImages.push({
                    dataUrl,
                    pageNumber: pageNum,
                    filename: `page_${pageNum.toString().padStart(3, '0')}.${format}`
                });

                addImageToGrid(dataUrl, pageNum, format, false);
            }
        }

        // é•¿æ¡æ¨¡å¼è½¬æ¢
        async function convertToLongImage(pdf, format, scale) {
            const trimMode = trimSelect.value;
            const spacing = parseInt(spacingSelect.value);
            const pageCanvases = [];

            // ç¬¬ä¸€æ­¥ï¼šæ¸²æŸ“æ‰€æœ‰é¡µé¢
            for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                const progress = 10 + (pageNum / pdf.numPages) * 40;
                showProgress(progress, `æ­£åœ¨æ¸²æŸ“ç¬¬ ${pageNum}/${pdf.numPages} é¡µ...`);

                const page = await pdf.getPage(pageNum);
                const viewport = page.getViewport({ scale });

                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                canvas.height = viewport.height;
                canvas.width = viewport.width;

                await page.render({
                    canvasContext: context,
                    viewport: viewport
                }).promise;

                pageCanvases.push(canvas);
            }

            // ç¬¬äºŒæ­¥ï¼šå¤„ç†ç©ºç™½å’Œåˆå¹¶
            showProgress(60, 'æ­£åœ¨å¤„ç†ç©ºç™½åŒºåŸŸ...');
            
            const trimmedCanvases = pageCanvases.map((canvas, index) => {
                showProgress(60 + (index / pageCanvases.length) * 20, `æ­£åœ¨å¤„ç†ç¬¬ ${index + 1} é¡µç©ºç™½...`);
                return trimWhitespace(canvas, trimMode);
            });

            // ç¬¬ä¸‰æ­¥ï¼šåˆå¹¶ä¸ºé•¿å›¾
            showProgress(80, 'æ­£åœ¨åˆå¹¶ä¸ºé•¿å›¾...');
            const mergedCanvas = await mergeCanvases(trimmedCanvases, spacing);

            const mimeType = format === 'png' ? 'image/png' : 'image/jpeg';
            const quality = format === 'jpeg' ? 0.9 : undefined;
            const dataUrl = mergedCanvas.toDataURL(mimeType, quality);

            mergedImage = {
                dataUrl,
                filename: `merged_long_image.${format}`,
                width: mergedCanvas.width,
                height: mergedCanvas.height
            };

            // æ¸…ç©ºç½‘æ ¼å¹¶æ·»åŠ é•¿å›¾é¢„è§ˆ
            imageGrid.innerHTML = '';
            addLongImageToGrid(dataUrl, pdf.numPages, format);
        }

        // å»é™¤ç©ºç™½çš„å‡½æ•°
        function trimWhitespace(canvas, trimMode) {
            const ctx = canvas.getContext('2d');
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;

            let top = 0, bottom = canvas.height, left = 0, right = canvas.width;

            // æ£€æµ‹ç©ºç™½åŒºåŸŸ (ç™½è‰²æˆ–æ¥è¿‘ç™½è‰²çš„åƒç´ )
            function isWhitePixel(r, g, b, a) {
                if (a < 10) return true; // é€æ˜åƒç´ 
                return r > 250 && g > 250 && b > 250; // æ¥è¿‘ç™½è‰²
            }

            if (trimMode === 'auto' || trimMode === 'top') {
                // æ£€æµ‹é¡¶éƒ¨ç©ºç™½
                topLoop: for (let y = 0; y < canvas.height; y++) {
                    for (let x = 0; x < canvas.width; x++) {
                        const idx = (y * canvas.width + x) * 4;
                        const r = data[idx];
                        const g = data[idx + 1];
                        const b = data[idx + 2];
                        const a = data[idx + 3];
                        if (!isWhitePixel(r, g, b, a)) {
                            top = Math.max(0, y - 10); // ä¿ç•™10pxè¾¹è·
                            break topLoop;
                        }
                    }
                }
            }

            if (trimMode === 'auto' || trimMode === 'bottom') {
                // æ£€æµ‹åº•éƒ¨ç©ºç™½
                bottomLoop: for (let y = canvas.height - 1; y >= 0; y--) {
                    for (let x = 0; x < canvas.width; x++) {
                        const idx = (y * canvas.width + x) * 4;
                        const r = data[idx];
                        const g = data[idx + 1];
                        const b = data[idx + 2];
                        const a = data[idx + 3];
                        if (!isWhitePixel(r, g, b, a)) {
                            bottom = Math.min(canvas.height, y + 10); // ä¿ç•™10pxè¾¹è·
                            break bottomLoop;
                        }
                    }
                }
            }

            if (trimMode === 'auto') {
                // æ£€æµ‹å·¦ä¾§ç©ºç™½
                leftLoop: for (let x = 0; x < canvas.width; x++) {
                    for (let y = top; y < bottom; y++) {
                        const idx = (y * canvas.width + x) * 4;
                        const r = data[idx];
                        const g = data[idx + 1];
                        const b = data[idx + 2];
                        const a = data[idx + 3];
                        if (!isWhitePixel(r, g, b, a)) {
                            left = Math.max(0, x - 5); // ä¿ç•™5pxè¾¹è·
                            break leftLoop;
                        }
                    }
                }

                // æ£€æµ‹å³ä¾§ç©ºç™½
                rightLoop: for (let x = canvas.width - 1; x >= 0; x--) {
                    for (let y = top; y < bottom; y++) {
                        const idx = (y * canvas.width + x) * 4;
                        const r = data[idx];
                        const g = data[idx + 1];
                        const b = data[idx + 2];
                        const a = data[idx + 3];
                        if (!isWhitePixel(r, g, b, a)) {
                            right = Math.min(canvas.width, x + 5); // ä¿ç•™5pxè¾¹è·
                            break rightLoop;
                        }
                    }
                }
            }

            // åˆ›å»ºè£å‰ªåçš„canvas
            const trimmedCanvas = document.createElement('canvas');
            const trimmedCtx = trimmedCanvas.getContext('2d');
            
            const newWidth = right - left;
            const newHeight = bottom - top;
            
            trimmedCanvas.width = newWidth;
            trimmedCanvas.height = newHeight;

            trimmedCtx.drawImage(
                canvas,
                left, top, newWidth, newHeight,
                0, 0, newWidth, newHeight
            );

            return trimmedCanvas;
        }

        // åˆå¹¶å¤šä¸ªcanvasä¸ºé•¿å›¾
        async function mergeCanvases(canvases, spacing) {
            if (canvases.length === 0) return null;

            // è®¡ç®—æ€»å°ºå¯¸
            const maxWidth = Math.max(...canvases.map(c => c.width));
            const totalHeight = canvases.reduce((sum, c) => sum + c.height, 0) + spacing * (canvases.length - 1);

            // åˆ›å»ºåˆå¹¶canvas
            const mergedCanvas = document.createElement('canvas');
            const ctx = mergedCanvas.getContext('2d');
            
            mergedCanvas.width = maxWidth;
            mergedCanvas.height = totalHeight;

            // å¡«å……ç™½è‰²èƒŒæ™¯
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, maxWidth, totalHeight);

            // é€ä¸ªç»˜åˆ¶é¡µé¢
            let currentY = 0;
            for (let i = 0; i < canvases.length; i++) {
                const canvas = canvases[i];
                const x = Math.floor((maxWidth - canvas.width) / 2); // å±…ä¸­å¯¹é½
                
                ctx.drawImage(canvas, x, currentY);
                currentY += canvas.height + spacing;
            }

            return mergedCanvas;
        }

        // æ·»åŠ é•¿å›¾åˆ°ç½‘æ ¼
        function addLongImageToGrid(dataUrl, totalPages, format) {
            const imageItem = document.createElement('div');
            imageItem.className = 'image-item long-image';
            imageItem.style.gridColumn = '1 / -1'; // å æ»¡æ•´è¡Œ
            
            const sizeInfo = mergedImage ? `${mergedImage.width} Ã— ${mergedImage.height}px` : '';
            
            imageItem.innerHTML = `
                <img src="${dataUrl}" alt="Merged Long Image" class="image-preview" style="height: auto; max-height: 400px;">
                <div class="image-info">
                    <div class="page-number">ğŸ“œ é•¿å›¾æ¨¡å¼ (${totalPages} é¡µåˆå¹¶)</div>
                    <div style="font-size: 0.8em; color: #666; margin: 5px 0;">${sizeInfo}</div>
                    <button class="download-btn" onclick="downloadLongImage()">
                        ğŸ’¾ ä¸‹è½½é•¿å›¾
                    </button>
                </div>
            `;
            
            imageGrid.appendChild(imageItem);
        }

        // æ·»åŠ å›¾ç‰‡åˆ°ç½‘æ ¼
        function addImageToGrid(dataUrl, pageNumber, format, showDownload = true) {
            const imageItem = document.createElement('div');
            imageItem.className = 'image-item';
            
            const downloadBtn = showDownload ? 
                `<button class="download-btn" onclick="downloadImage(${pageNumber - 1})">ğŸ’¾ ä¸‹è½½</button>` : '';
            
            imageItem.innerHTML = `
                <img src="${dataUrl}" alt="Page ${pageNumber}" class="image-preview">
                <div class="image-info">
                    <div class="page-number">ç¬¬ ${pageNumber} é¡µ</div>
                    ${downloadBtn}
                </div>
            `;
            
            imageGrid.appendChild(imageItem);
        }

        // ä¸‹è½½å•ä¸ªå›¾ç‰‡
        function downloadImage(index) {
            if (convertedImages[index]) {
                const image = convertedImages[index];
                const link = document.createElement('a');
                link.download = image.filename;
                link.href = image.dataUrl;
                link.click();
            }
        }

        // ä¸‹è½½é•¿å›¾
        function downloadLongImage() {
            if (mergedImage) {
                const link = document.createElement('a');
                link.download = mergedImage.filename;
                link.href = mergedImage.dataUrl;
                link.click();
            }
        }

        // ä¸‹è½½æ‰€æœ‰å›¾ç‰‡ (ZIP)
        async function downloadAllImages() {
            const mode = modeSelect.value;
            
            if (mode === 'merge') {
                // é•¿æ¡æ¨¡å¼ç›´æ¥ä¸‹è½½é•¿å›¾
                downloadLongImage();
                return;
            }

            if (convertedImages.length === 0) return;

            try {
                downloadAllBtn.textContent = 'ğŸ“¦ æ­£åœ¨æ‰“åŒ…...';
                downloadAllBtn.disabled = true;

                const zip = new JSZip();
                
                for (const image of convertedImages) {
                    // å°† dataURL è½¬æ¢ä¸º blob
                    const response = await fetch(image.dataUrl);
                    const blob = await response.blob();
                    zip.file(image.filename, blob);
                }

                const zipBlob = await zip.generateAsync({ type: 'blob' });
                const link = document.createElement('a');
                link.download = 'pdf_images.zip';
                link.href = URL.createObjectURL(zipBlob);
                link.click();

                downloadAllBtn.textContent = 'ğŸ“¦ ä¸‹è½½æ‰€æœ‰å›¾ç‰‡ (ZIP)';
                downloadAllBtn.disabled = false;

            } catch (error) {
                showError('æ‰“åŒ…ä¸‹è½½å¤±è´¥: ' + error.message);
                downloadAllBtn.textContent = 'ğŸ“¦ ä¸‹è½½æ‰€æœ‰å›¾ç‰‡ (ZIP)';
                downloadAllBtn.disabled = false;
            }
        }

        // æ˜¾ç¤º/éšè—è¿›åº¦
        function showProgress(percent, text) {
            progressContainer.style.display = 'block';
            progressFill.style.width = percent + '%';
            progressText.textContent = text;
        }

        function hideProgress() {
            progressContainer.style.display = 'none';
        }

        // æ˜¾ç¤º/éšè—é”™è¯¯
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
        }

        function hideError() {
            errorMessage.style.display = 'none';
        }

        // æ˜¾ç¤ºç»“æœ
        function showResults() {
            results.style.display = 'block';
        }

        // é‡ç½®åº”ç”¨
        function resetApp() {
            fileInput.value = '';
            fileInfo.style.display = 'none';
            results.style.display = 'none';
            imageGrid.innerHTML = '';
            convertedImages = [];
            mergedImage = null;
            hideError();
            hideProgress();
            
            // é‡ç½®ä¸‹è½½æŒ‰é’®æ–‡æœ¬
            const mode = modeSelect.value;
            downloadAllBtn.textContent = mode === 'merge' ? 'ğŸ“œ ä¸‹è½½é•¿å›¾' : 'ğŸ“¦ ä¸‹è½½æ‰€æœ‰å›¾ç‰‡ (ZIP)';
        }

        // æ›´æ–°ä¸‹è½½æŒ‰é’®æ–‡æœ¬
        function updateDownloadButtonText() {
            const mode = modeSelect.value;
            downloadAllBtn.textContent = mode === 'merge' ? 'ğŸ“œ ä¸‹è½½é•¿å›¾' : 'ğŸ“¦ ä¸‹è½½æ‰€æœ‰å›¾ç‰‡ (ZIP)';
        }

        // æ›´æ–°æç¤ºä¿¡æ¯
        function updateModeHint() {
            const modeHint = document.getElementById('modeHint');
            const mode = modeSelect.value;
            
            if (mode === 'merge') {
                modeHint.textContent = 'ğŸ“œ é•¿æ¡æ¨¡å¼ï¼šå°†æ‰€æœ‰é¡µé¢åˆå¹¶ä¸ºä¸€å¼ é•¿å›¾ï¼Œæ™ºèƒ½å»é™¤ç©ºç™½åŒºåŸŸ';
                modeHint.style.background = '#e8f5e8';
                modeHint.style.color = '#2e7d32';
            } else {
                modeHint.textContent = 'ğŸ“„ åˆ†é¡µæ¨¡å¼ï¼šæ¯ä¸ªPDFé¡µé¢è½¬æ¢ä¸ºå•ç‹¬çš„å›¾ç‰‡æ–‡ä»¶';
                modeHint.style.background = '#f3e5f5';
                modeHint.style.color = '#7b1fa2';
            }
        }

        // ç›‘å¬æ¨¡å¼å˜åŒ–
        modeSelect.addEventListener('change', () => {
            handleModeChange();
            updateDownloadButtonText();
            updateModeHint();
        });
        
        // åˆå§‹åŒ–
        updateModeHint();

        // é˜²æ­¢é¡µé¢æ‹–æ‹½æ‰“å¼€æ–‡ä»¶
        document.addEventListener('dragover', e => e.preventDefault());
        document.addEventListener('drop', e => e.preventDefault());
    </script>
</body>
</html>